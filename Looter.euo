; Looter v1.3.0 2014-10-18T20:44:46-03:00
; more on github.com/haggen/euo
;
; About:
; On the first run you'll be asked for a lootsack - the container
; where the loot will be put into. Then it'll survey the area around
; you for corpses, up to 2 tiles away. Whenever a corpse is found
; it'll drag the items that match the loot table into the lootsack.
; If something prevents the item from being moved (lag, you're dead,
; etc.) it'll go back to survey mode and try to repeat the procedure.
; After all the items are moved the corpse will be ignored until the
; execution is restarted. If the lootsack is unreachable for any
; reason, you'll be asked to target it again. Consecutive runs will
; remember a previously selected lootsack.
;
; Depends on:
; - Library v1.2 [github.com/haggen/euo/Library.euo]
;
; Known issues:
; - Your maximum weight is not being considered
; - It'll overlap currently lifted items and that may cause problems
;
; Roadmap:
; - Refactor loot table (split into more categories, add missing items)
; - Allow the player to choose between 2 modes; full auto or hot key
;

; Speed things up
set #lpc 100

; Turn on/off debug messages
set %debug #false

; Define correct namespace
if #nsname <> Looter
{
  namespace push
  namespace global Looter
}

;::::::::::::::::::::::::::::::::::::::::::::::::::::::
; CONFIGURATION SECTION - DO NOT EDIT ABOVE THIS LINE!
;::::::::::::::::::::::::::::::::::::::::::::::::::::::

; 1. Change the values below to define your hotkey

; CTRL, SHIFT, ALT, or <blank>
set %mod CTRL

; Any of the following:
; A-Z, 0-9, F1-F12, ESC, BACK, TAB, ENTER,
; PAUSE, CAPSLOCK, SPACE, PGDN, PGUP, END,
; HOME, LEFT, RIGHT, UP, DOWN, PRNSCR,
; INSERT, DELETE, NUMLOCK or SCROLLLOCK
set %key A

; 2. Comment in/out the lines below to select the loot you want

; Gold
set !loot POF_

; Magery reagents
set !loot !loot , KZF_SZF_MZF_JUF_RZF_KUF_WZF_

; Gems, including Arcane Gem
set !loot !loot , EVF_GVF_ZVF_BVF_RVF_HVF_VVF_JSL_UVF_NVF_

; Bags, backpacks and other containers
set !loot !loot , ZJF_LKF_CKF_YKK_

; Swords and axes
set !loot !loot , YPO_BNF_CPH_INF_FSF_OSF_ASF_HNF_FMH_CNF_LSF_NSF_ISF_SMH_RMH_CSF_ZRF_MPH_LPH_MSF_BSF_KPO_GUO_KTF_JTF_BPH_EPH_ZSF_ATF_JPH_SOH_POH_NMH_OMH_LPO_ZTO_XTH_YTH_HSF_KSF_NPO_XPO_FUO_JPO_QPF_NPF_KPH_FYG_RHM_SFR_

; Bows, crossbows and ammunition
set !loot !loot , WOH_TOH_QPO_SPO_WOH_TOH_JSF_USF_LMH_MMH_QPO_SPO_PPO_RPO_JSF_USF_LMH_MMH_PPO_RPO_JSF_RWF_LNK_FKF_

; Leather armor
set !loot !loot , VKH_NJL_QJL_JKH_QKH_DLH_HKH_PKH_SKH_KKH_ELH_PSF_QSK_ATK_ZSK_OSK_YSK_NSK_

; Studded leather armor
set !loot !loot , ALH_ULH_LLH_YKH_GLH_XKH_FLH_RLH_MLH_SSK_RSK_

; Platemail
set !loot !loot , MSH_LSH_NSH_ISH_HSH_KSH_JSH_USH_WSH_ASH_ESH_GSH_OSH_CSH_

; Shields
set !loot !loot , LIK_MIK_CLK_AIK_CIK_LYD_GIK_NIK_ZHK_HLK_BLK_FIK_BIK_OIK_

; Musical instruments
set !loot !loot , OQF_LQF_PRF_KRF_MQF_QRF_RGP_PGP_

;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
; END OF CONFIGURATION SECTION - DO NOT EDIT BELOW THIS LINE!
;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

; Try to use graphical menu
call Looter-Menu.euo

; Log selected hot key
call Library.euo debug Hotkey is %mod %key

; Make sure a lootsack's been selected
gosub lootsack

; Listen to the hotkey
idle:
  call Library.euo debug Idle
  call Library.euo debug Loot:
  call Library.euo debug !loot
  wait 10
  
loop:
  call Looter-Menu.euo refresh
  onhotkey %key %mod
    goto survey
  goto loop

; Look for corpses up to 2 tiles away
survey:
  call Library.euo debug Survey

  finditem YFM_WNF_QNF g_2

  if #findcnt = 0
    goto idle

  call Library.euo benchmark

  set %corpse #findid
  event exmsg %corpse 0 28 Corpse

  set #nextcposx 50
  set #nextcposy 50

  ; Open the corpse
  set %j #jindex
  set #lobjectid %corpse
  event macro 17
  wait 10

  ; If you're dead, abort
  call Library.euo journal %j I_am_dead
  if #result
    goto idle

  ; Check if we can loot the corpse
  call Library.euo journal %j criminal_act
  if #result
  {
    event exmsg %corpse 0 28 Nope
    ignoreitem %corpse
    goto idle
  }

  ; If the container size does not match
  ; a corpse container, look again
  if #contsize <> 144_212
    goto survey

  ; Make sure there's a lootsack defined and it's accessible
  gosub lootsack

; Find the loot
loot:
  finditem !loot c_ , %corpse

  ; If no selected loot is found,
  ; mark corpse as empty and move on
  if #findcnt = 0
  {
    event exmsg %corpse 0 28 Empty
    ignoreitem %corpse
    goto idle
  }

  ; For each item found, try to drag it to your
  ; lootsack, whilst checking for possible failures
  while #findindex <= #findcnt
  {
    event property #findid
    call Library.euo debug [ , #findindex , / , #findcnt , ] #property

    set %j #jindex

    ; Move the item
    exevent drag #findid #findstack
    exevent dropc *lootsack
    wait 6

    ; Check for failure messages
    call Library.euo journal %j must_wait_to_perform
    if #result
      continue

    call Library.euo journal %j I_am_dead
    if #result
      goto survey

    call Library.euo journal %j cannot_do_that
    if #result
      goto survey

    call Library.euo journal %j too_far_away
    if #result
      goto survey

    call Library.euo journal %j out_of_sight
    if #result
      goto survey

  ; Move on to the next item
    set #findindex #findindex + 1
  }

  call Library.euo benchmark
  event exmsg #charid 0 28 Acquired #findcnt item(s) in #result sec
  
  ; Make sure you looted everything
  goto loot

; Find previously selected lootsack, otherwise target a new one
sub lootsack
  finditem *lootsack

  if #findcnt = 0
  {
    event exmsg #charid 0 28 Target lootsack
    call Library.euo target
    set *lootsack #result
  }

  return
